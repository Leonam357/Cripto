<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <title>Investimentos em Cripto</title>
    <script type="text/javascript" src="https://files.coinmarketcap.com/static/widget/currency.js"></script>
    <script type="text/javascript" src="https://files.coinmarketcap.com/static/widget/coinMarquee.js"></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Regras de responsividade */
        @media (max-width: 768px) {
            .widget-container {
    position: relative;
    overflow: hidden;
                width: 95% !important;
                /*flex-direction: column;*/
            }
            
            .marquee-container {
    width: 100%;
    padding: 0 15px;
    box-sizing: border-box;
    overflow: hidden;
    }

    @media (max-width: 768px) {
        .marquee-container {
            padding: 0 10px;
        }
        
        #coinmarketcap-widget-marquee {
            height: 35px !important;
            font-size: 0.9em;
        }
    }

    @media (max-width: 480px) {
        #coinmarketcap-widget-marquee {
            height: 30px !important;
            font-size: 0.8em;
        }
    }

    .input-group {
                    width: 100% !important;
                    margin: 10px 0;
                }

                .coin-info {
                    flex-direction: column;
                }

                .alert-section {
                    flex-wrap: wrap;
                }
            }

            @media (max-width: 480px) {
                .button {
                    width: 100%;
                }

                .header-container {
                    width: 100% !important;
                    text-align: center;
                }
            }

            body {
                margin: 0;
                padding: 5px;
                background: transparent;
                display: flex;
                flex-direction: column;
                gap: 5px;
                font-family: Arial, sans-serif;
                align-items: center;
            }

            .header-container {
                display: inline;
                justify-content: center;
                align-items: center;
                width: 450px;
                margin-bottom: 1px;
            }

            .timer {
                font-size: 16px;
                font-weight: bold;
                color: #333;
            }

            .button_ChangeCoin {
                padding: 3px;
                width: 170px;
                border: none;
                border-radius: 5px;
                background: #3835dc;
                color: white;
                font-size: 1em;
                cursor: pointer;
                margin-bottom: 10px;
                margin-top: 20px;
            }
            .button_ChangeCoin:hover {
                background: #201e8b;
            }

            .button {
                padding: 3px;
                width: 100px;
                border: none;
                border-radius: 5px;
                background: #dc3545;
                color: white;
                font-size: 1em;
                cursor: pointer;
                margin-top: 20px;
            }

            .button:hover {
                background: #861722;
            }

            .widget-container {
                /*display: flex;
                flex-wrap: wrap;*/
                max-width: 100%;
                min-width: unset;
                width: 100%;
                flex-direction: column; /* Alinha os elementos verticalmente */
                gap: 10px;
                background: rgba(39, 39, 39, 0.9);
                border-radius: 8px;
                padding: 15px;
                box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
                width: 500px;
                border: 1px solid #868585; /* Adiciona uma borda cinza fina */
            }

            .input-group {
                /*display: flex;
                flex-direction: column;*/
                gap: 5px;
                width: 100%;
                min-width: 150px;
                margin: 15px 0 10px 0;
                box-sizing: border-box;
                text-align: center; /* Alinha verticalmente os elementos */
            }

            .input-group label {     /* formato dos labels Alertas min / máx e preço atual */
                /*display: flex;
                flex-direction: column;*/
                font-size: 0.8em;
                padding-left: 1px;
                gap: 5px;
                color: #999999;
                max-width: 140px;
                height: 30px;
            }

            .input-field {           /* bordas dos Edit box dos valores */
                /*display: flex;
                flex-direction: column;*/
                padding: 8px;
                border: 1px solid #dddddd;
                border-radius: 4px;
                font-size: 0.9em;
                max-width: 140px;
                height: 8px;
            }

            .result-field {         /* formato dos Edit box dos valores */
                /*display: flex;
                flex-direction: column;*/
                padding: 5px;
                background: #fcfcfc;
                border: 1px solid #ddd;
                border-radius: 4px;
                font-size: 0.9em;
                color: #333;
                max-width: 140px;
                /*height: 40px;*/
            }

            .coin-info {             /* formato e dimensões dos resultados do coinmarketcap */
                display: flex;
                justify-content: space-between; /* Posiciona os elementos lado a lado */
                align-items: center; /* Alinha verticalmente os elementos */
                gap: 10px; /* Espaçamento entre os elementos */
                width: 100%; /* Garante que ocupe toda a largura */
                
            }

            .coinmarketcap-currency-widget {    /* Borda esquerda coinmarketcap */
                flex: 1; /* Ocupa o espaço disponível à esquerda */
                min-width: 200px; /* Define uma largura mínima */
            }
            .gain-info {
                display: flex;
                flex-direction: column; /* Alinha o rótulo e o valor verticalmente */
                align-items: flex-end; /* Alinha o conteúdo à direita */
                gap: 5px; /* Espaçamento entre o rótulo e o valor */
            }

            .alert {
                color:white;
                background-color: #901a94 !important;
            }

            .alert-gain {
                color:white;
                background-color: #9c34a0 !important;
            }

            .calculation-section {/* formato dos labels Valor Investido/Qtde de Moedas/Moeda na Compra/Ganho Atual*/
                flex: 1;
                display: flex;
                justify-content: space-between;
                flex-direction: row;
                gap: 10px;
                padding-left: 10px;
                border-left: 1px solid rgba(0,0,0,0.1);
            }

        .alert-section {    /* formato e dimensões dos alertas min e max */
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: 5px;
                width: 100%; /* Garante que ocupe toda a largura */
            }

            .alert-section .input-group {   /* formato e dimensões dos alertas min e max */
                flex: 1;  
                text-align: center;
                margin: 0;
            }

            .alert-section .input-group label {     /* formato dos labels Alerta mín(R$) e Alerta máx(R$) */
                font-size: 0.8em;
                color: #999999;
                margin-bottom: 2px; /* Reduz o espaço abaixo do rótulo */
            }

            .alert-section .input-group .input-field,
            .alert-section .input-group .result-field {
                width: 100%;
                text-align: center;
            }

            .price-field {          /* formato do label Preço Atual da Moeda) */
                background-color: #acacac; /* Cinza claro */
                color: #000000; /* Cor do texto */
                border: 1px solid #ddd; /* Borda */
                border-radius: 4px;
                padding: 8px;
                font-size: 0.9em;
                font-weight: bold;
                text-align: center;
                max-width: 140px;
                min-height: 20px; /* Aumentado de 10px para 20px */
                line-height: 20px; /* Adicionado para centralizar verticalmente */
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .positive {
                color: #28a745 !important;
                background-color: #cef1d1 !important;
                border-color: #cef1d1 !important;
            }

            .negative {
                color: #dc3545 !important;
                background-color: #f8ccd0 !important;
                border-color: #f0bbc0 !important;  
            }
        
        
    </style>
</head>
<body style="background: #1a1a1a; color: #ffffff">
    <div class="header-container">
        <h3>Bem-vindo, <span id="userDisplayName"></span></h3>
        <font size="3px"> (atualiza em: <span class="timer" id="timerDisplay" style="color: #999999;">00:30</span></font>)
    </div>

    <button class="button" id="stopAlarmButton" onclick="stopAlarm()" style="display: none"; >
        Parar Alarme
    </button>

    <div id="cryptoContainer"></div>

    <button class="button_ChangeCoin" onclick="sessionStorage.removeItem('CoinSelected'); window.location.href='coinlist.html'">
        Trocar Moeda
    </button>
            
    <button class="button" onclick="logout()">
        Sair
    </button>

    <audio id="alarmSound" loop preload="auto" playsinline>
        <source src="alert-noise-cripto.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Inicializa o áudio para dispositivos móveis
        document.addEventListener('DOMContentLoaded', function() {
            const audio = document.getElementById('alarmSound');
            // Carrega o áudio sem reproduzir
            audio.load();
            // Habilita reprodução em dispositivos móveis
            document.addEventListener('touchstart', function() {
                if (!alarmPlaying) {
                    audio.play().then(() => audio.pause());
                }
            }, { once: true });
        });

        // Variável global para definir a moeda escolhida pelo usuario para ser monitorada
        let storedCoin = JSON.parse(sessionStorage.getItem('CoinSelected'));
        if (!storedCoin && currentUser) {
            // Tenta recuperar a última moeda selecionada do localStorage
            const lastSelectedCoin = localStorage.getItem(`lastSelectedCoin_${currentUser}`);
            if (lastSelectedCoin) {
                storedCoin = JSON.parse(lastSelectedCoin);
                sessionStorage.setItem('CoinSelected', lastSelectedCoin);
            } else {
                window.location.href = 'coinlist.html';
            }
        } else if (!storedCoin) {
            window.location.href = 'coinlist.html';
        }
        const UserCoins = [storedCoin];
    </script>
    

    <script>
        let refreshTimer;
        //document.getElementById('stopAlarmButton').style.display = "none";  //desabilita o botão de alarme
        let countdownTimer;
        const refreshInterval = 30;
        let countdown = refreshInterval;

        let alarmPlaying = false;
        let alarmDisabled = false;         
        
        let lastState = { litecoin: { min: false, max: false }, bitcoin: { min: false, max: false }, uniswap: { min: false, max: false } };

        let currentUser = sessionStorage.getItem("currentUser") || localStorage.getItem("savedUser");

        if (!currentUser) {
            window.location.href = "coinlist.html";
        } else {
            document.getElementById("userDisplayName").textContent = currentUser;
            loadCryptoInputs();
            startAutoRefresh();
            startCountdown();
        }

        /**
         * Inicia o processo de atualização automática da página
         * Recarrega a página após o intervalo definido em refreshInterval
         */
        function startAutoRefresh() {
            refreshTimer = setTimeout(() => {
                location.reload();
            }, refreshInterval * 1000);
        }

        /**
         * Inicia a contagem regressiva para próxima atualização
         * Atualiza o display do contador a cada segundo
         */
        function startCountdown() {
            countdown = refreshInterval;
            updateCountdownDisplay();

            countdownTimer = setInterval(() => {
                countdown--;
                updateCountdownDisplay();

                if (countdown <= 0) {
                    clearInterval(countdownTimer);
                    countdown = refreshInterval;
                    startCountdown();
                }
            }, 1000);
        }

        /**
         * Atualiza o display do contador regressivo
         * Formata o tempo restante em minutos e segundos
         */
        function updateCountdownDisplay() {
            let minutes = Math.floor(countdown / 60);
            let seconds = countdown % 30;
            document.getElementById("timerDisplay").textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        /**
         * Carrega os alertas de preço salvos no localStorage
         * Recupera e define os valores mínimos e máximos para alertas
         */
        function loadPriceAlerts() {
            const savedMinPrice = localStorage.getItem('minPriceAlert');
            const savedMaxPrice = localStorage.getItem('maxPriceAlert');

            if (savedMinPrice) {
                document.getElementById('minPrice').value = savedMinPrice;
                minPriceAlert = parseFloat(savedMinPrice);
            }

            if (savedMaxPrice) {
                document.getElementById('maxPrice').value = savedMaxPrice;
                maxPriceAlert = parseFloat(savedMaxPrice);
            }
        }

        /**
         * Define um alerta de preço para uma moeda específica
         * @param {string} currencyId - ID da moeda
         * @param {string} type - Tipo do alerta ('min' ou 'max')
         * @param {string} value - Valor do alerta
         */
        function setPriceAlert(currencyId, type, value) {
            const key = `${currencyId}_${type}PriceAlert`;
            localStorage.setItem(`crypto_${currentUser}_${key}`, value || '');
            fetchCurrentPrices(); // Atualiza os valores imediatamente após definir os alertas
        }
        
        /**
         * Dispara o alarme sonoro e visual quando um alerta é ativado
         * @param {string} type - Tipo do alerta ('min' ou 'max')
         */
        function triggerAlarm(type) {
            if (!alarmPlaying && !alarmDisabled) {
                const audioElement = document.getElementById('alarmSound');
                // Tenta reproduzir o áudio com interação do usuário para Android
                const playPromise = audioElement.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(_ => {
                        document.getElementById('stopAlarmButton').style.display = "block";
                        alarmPlaying = true;
                        
                        if (type === 'min') {
                            document.getElementById('minPrice').classList.add("alert");
                        } else if (type === 'max') {
                            document.getElementById('maxPrice').classList.add("alert");
                        }
                    })
                    .catch(error => {
                        console.log("Erro ao tocar alarme: ", error);
                        // Tenta novamente com interação do usuário
                        document.addEventListener('touchstart', function() {
                            audioElement.play();
                        }, { once: true });
                    });
                }

            //const gainElement = document.getElementById(`gain_${currencyId}`);
            //if (gainElement) gainElement.classList.add("alert-gain");
            }
        }
        

        /**
         * Para o alarme sonoro e visual
         * Desabilita temporariamente o alarme por 5 segundos
         */
        function stopAlarm() {
            document.getElementById('alarmSound').pause();
            document.getElementById('alarmSound').currentTime = 0;
            document.getElementById('stopAlarmButton').style.display = "none"; // Esconder botão de alarme
            alarmPlaying = false;
            alarmDisabled = true;

            document.getElementById('minPrice').classList.remove("alert");
            document.getElementById('maxPrice').classList.remove("alert");
            
            setTimeout(() => {
                alarmDisabled = false; 
            }, 5000); 
        }

        /**
         * Verifica se o preço atual atingiu os valores de alerta
         * @param {string} currencyId - ID da moeda
         * @param {number} currentPrice - Preço atual da moeda
         */
        function checkPriceAlerts(currencyId, currentPrice) {
            const minPriceAlert = parseFloat(localStorage.getItem(`crypto_${currentUser}_${currencyId}_minPriceAlert`)) || null;
            const maxPriceAlert = parseFloat(localStorage.getItem(`crypto_${currentUser}_${currencyId}_maxPriceAlert`)) || null;

            if (minPriceAlert && currentPrice < minPriceAlert) {
                if (!lastState[currencyId].min) {
                    triggerAlarm('min');
                    lastState[currencyId].min = true;
                }
            } else {
                lastState[currencyId].min = false;
            }

            if (maxPriceAlert && currentPrice > maxPriceAlert) {
                if (!lastState[currencyId].max) {
                    triggerAlarm('max');
                    lastState[currencyId].max = true;
                }
            } else {
                lastState[currencyId].max = false;
            }
        }

        /**
         * Realiza o logout do usuário
         * Limpa os timers, remove dados da sessão e redireciona para a página inicial
         */
        function logout() {
            clearTimeout(refreshTimer);
            clearInterval(countdownTimer);
            
            // Salva a moeda selecionada no localStorage antes de fazer logout
            const selectedCoin = sessionStorage.getItem('CoinSelected');
            if (selectedCoin && currentUser) {
                localStorage.setItem(`lastSelectedCoin_${currentUser}`, selectedCoin);
            }
            
            localStorage.removeItem("savedUser");
            sessionStorage.removeItem("currentUser");
            sessionStorage.removeItem("CoinSelected");
            window.location.href = "index.html";

            setTimeout(() => {
                window.close();
            }, 1000);
        }

        /**
         * Carrega e exibe os inputs e informações das criptomoedas
         * Recupera valores salvos e configura os widgets para cada moeda
         */
        function loadCryptoInputs() {
            const container = document.getElementById("cryptoContainer");
            container.innerHTML = "";

            UserCoins.forEach(crypto => {
                let invested = parseFloat(localStorage.getItem(`crypto_${currentUser}_${crypto.name}_invested`)) || 0;
                let qtde = parseFloat(localStorage.getItem(`crypto_${currentUser}_${crypto.name}_qtde`)) || 0;
                let moedaNaCompra = parseFloat(localStorage.getItem(`crypto_${currentUser}_${crypto.name}_moedaNaCompra`)) || 0;
                let minPriceAlert = parseFloat(localStorage.getItem(`crypto_${currentUser}_${crypto.name}_minPriceAlert`)) || '';
                let maxPriceAlert = parseFloat(localStorage.getItem(`crypto_${currentUser}_${crypto.name}_maxPriceAlert`)) || '';

                if ((!moedaNaCompra || isNaN(moedaNaCompra)) && invested && qtde) {
                    moedaNaCompra = parseFloat((invested / qtde).toFixed(2));
                    localStorage.setItem(`crypto_${currentUser}_${crypto.name}_moedaNaCompra`, moedaNaCompra);
                }

                const gain = localStorage.getItem(`crypto_${currentUser}_${crypto.name}_gain`) || 'R$ 0,00';
                fetchCurrentPrices(); 

                container.innerHTML += `
                    <div class="widget-container" data-currency="${crypto.name}">
                        <div class="coin-info">
                            <div class="coinmarketcap-currency-widget" 
                                data-currencyid="${crypto.id}" 
                                data-base="BRL" 
                                data-ticker="true" 
                                data-rank="true">
                            </div>
                        <div class="gain-info">
                                <div class="input-group">
                                    <label>Saldo Atual</label>
                                    <div class="result-field gain" id="saldo_${crypto.name}">0,00</div>
                                </div>
                                <div class="input-group">
                                    <label>Ganho R$</label>
                                    <div class="result-field gain" id="gain_${crypto.name}">${gain}</div>
                                </div>
                            </div>
                        </div>
                        <div class="alert-section">
                            <div class="input-group">
                                <label>Alerta de mín</label>
                                <input type="text" class="input-field min-price" 
                                    value="${minPriceAlert ? parseFloat(minPriceAlert).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : ''}" 
                                    min="0" step="1.00"
                                    onchange="setPriceAlert('${crypto.name}', 'min', this.value)"
                                    onblur="setPriceAlert('${crypto.name}', 'min', this.value)"
                                    onkeypress="if(event.key === 'Enter') { this.blur(); }">
                            </div>
                            <div class="input-group">
                                <label>Preço Atual ${crypto.name}</label>
                                <div class="result-field price-field" id="price_${crypto.name}">0,00</div>
                            </div>
                            <div class="input-group">
                                <label>Alerta de máx</label>
                                <input type="text" class="input-field max-price" 
                                    value="${maxPriceAlert ? parseFloat(maxPriceAlert).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : ''}" 
                                    min="0" step="1.00"
                                    onchange="setPriceAlert('${crypto.name}', 'max', this.value)"
                                    onblur="setPriceAlert('${crypto.name}', 'max', this.value)"
                                    onkeypress="if(event.key === 'Enter') { this.blur(); }">
                            </div>
                        </div>
                        
                        <div class="calculation-section">
                            <div class="input-group">
                                <label>R$ Investido</label>
                                <input type="text" class="input-field invested" 
                                    value="${invested ? invested.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : ''}" 
                                    min="0" step="1.00"
                                    onchange="saveCryptoValue('${crypto.name}', 'invested', this.value)"
                                    onblur="saveCryptoValue('${crypto.name}', 'invested', this.value)"
                                    onkeypress="if(event.key === 'Enter') { this.blur(); }">
                            </div>
                            <div class="input-group">
                                <label>Qtde Moedas</label>
                                <input type="number" class="input-field purchase-qtde" 
                                    value="${qtde ? parseFloat(qtde).toFixed(8) : ''}" 
                                    min="0" step="0.00000001"
                                    onchange="saveCryptoValue('${crypto.name}', 'qtde', this.value)"
                                    onblur="saveCryptoValue('${crypto.name}', 'qtde', this.value)"
                                    onkeypress="if(event.key === 'Enter') { this.blur(); }">
                            </div>
                            <div class="input-group">
                                <label>Valor na Compra</label>
                                <input type="text" class="input-field moeda-compra" 
                                    value="${moedaNaCompra ? moedaNaCompra.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' }) : ''}" 
                                    min="0" step="0.01"
                                    onchange="saveCryptoValue('${crypto.name}', 'moedaNaCompra', this.value)"
                                    onblur="saveCryptoValue('${crypto.name}', 'moedaNaCompra', this.value)"
                                    onkeypress="if(event.key === 'Enter') { this.blur(); }">
                            </div>
                        </div>
                        <div id="coinmarketcap-widget-marquee" 
                                coins="2,7083,5426,1" 
                                currency="BRL" 
                                theme="dark" 
                                transparent="true" 
                                show-symbol-logo="true">
                            </div>
                    </div>
                `;
            });

            reloadCoinMarketCapWidget();
            fetchCurrentPrices();
        };

        /**
         * Recarrega o widget da CoinMarketCap
         * Remove o script antigo e adiciona um novo para atualizar os dados
         */
        function reloadCoinMarketCapWidget() {
            const oldScript = document.querySelector('script[src="https://files.coinmarketcap.com/static/widget/currency.js"]');
            if (oldScript) oldScript.remove();

            const newScript = document.createElement('script');
            newScript.src = 'https://files.coinmarketcap.com/static/widget/currency.js';
            document.body.appendChild(newScript);
        }

        /**
         * Salva os valores das criptomoedas e atualiza os cálculos
         * @param {string} currencyId - ID da moeda
         * @param {string} field - Campo a ser atualizado (invested, qtde, moedaNaCompra)
         * @param {string} value - Novo valor
         */
        function saveCryptoValue(currencyId, field, value) {
            const parsedValue = parseFloat(value).toFixed(field === 'qtde' ? 6 : 2);
            localStorage.setItem(`crypto_${currentUser}_${currencyId}_${field}`, parsedValue);

            const widget = document.querySelector(`#cryptoContainer .widget-container[data-currency="${currencyId}"]`);
            const invested = parseFloat(localStorage.getItem(`crypto_${currentUser}_${currencyId}_invested`)) || 0;
            const qtde = parseFloat(localStorage.getItem(`crypto_${currentUser}_${currencyId}_qtde`)) || 0;
            const valor_na_compra = parseFloat(localStorage.getItem(`crypto_${currentUser}_${currencyId}_moedaNaCompra`)) || 0;
            gainElement.textContent = 0;
            

            if (field === 'invested') {
                const newMoeda = qtde > 0 ? parseFloat((invested / qtde).toFixed(2)) : 0;
                localStorage.setItem(`crypto_${currentUser}_${currencyId}_moedaNaCompra`, newMoeda);
                widget.querySelector('.moeda-compra').value = newMoeda.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                calculateGain(currencyId);
            } 
            else if (field === 'qtde') {
                if (invested > 0) {
                    const newMoeda = parseFloat((invested / qtde).toFixed(2));
                    localStorage.setItem(`crypto_${currentUser}_${currencyId}_moedaNaCompra`, newMoeda);
                    widget.querySelector('.moeda-compra').value = newMoeda.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    calculateGain(currencyId);
                }
                if (valor_na_compra > 0) {
                    const newInvested = parseFloat((valor_na_compra * qtde).toFixed(2));
                    localStorage.setItem(`crypto_${currentUser}_${currencyId}_invested`, newInvested);
                    widget.querySelector('.invested').value = newInvested.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                    calculateGain(currencyId);
                }
            }
            else if (field === 'moedaNaCompra') {
                const newInvested = parseFloat((valor_na_compra * qtde).toFixed(2));
                localStorage.setItem(`crypto_${currentUser}_${currencyId}_invested`, newInvested);
                widget.querySelector('.invested').value = newInvested.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                calculateGain(currencyId);
            }

            calculateGain(currencyId);
            fetchCurrentPrices(); // Atualiza os valores imediatamente após os cálculos
        }

        /**
         * Busca os preços atuais das criptomoedas na API CoinGecko
         * Atualiza os preços, saldos e verifica alertas
         */
        function fetchCurrentPrices() {
            // Usando CoinGecko API como alternativa (não requer API key e não tem problemas de CORS)
            UserCoins.forEach(crypto => {
                // Verificar se temos o geckoId (ID da CoinGecko) para esta moeda
                const geckoId = crypto.geckoId || crypto.id;
                const coinName = crypto.name.toLowerCase();
                
                // URL da API CoinGecko
                const url = `https://api.coingecko.com/api/v3/coins/${geckoId}?localization=false&tickers=false&market_data=true&community_data=false&developer_data=false`;
                
                console.log(`Buscando dados para ${coinName} com ID ${geckoId}`);
                
                fetch(url)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error(`Erro HTTP: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Obter o preço em BRL
                        const price = data.market_data.current_price.brl || 0;
                        console.log(`Preço de ${coinName}: R$ ${price}`);
                        
                        let qtde = parseFloat(localStorage.getItem(`crypto_${currentUser}_${coinName}_qtde`)) || 0;
                        const invested = parseFloat(localStorage.getItem(`crypto_${currentUser}_${coinName}_invested`)) || 0;
                        const moedaNaCompra = parseFloat(localStorage.getItem(`crypto_${currentUser}_${coinName}_moedaNaCompra`)) || 0;
                        
                        if (qtde === 0 && invested > 0 && moedaNaCompra > 0) {
                            qtde = parseFloat((invested / moedaNaCompra).toFixed(8));
                            localStorage.setItem(`crypto_${currentUser}_${coinName}_qtde`, qtde);
                        } else if (qtde > 0 && invested > 0 && moedaNaCompra === 0) {
                            const novoMoedaNaCompra = parseFloat((invested / qtde).toFixed(2));
                            localStorage.setItem(`crypto_${currentUser}_${coinName}_moedaNaCompra`, novoMoedaNaCompra);
                        }

                        // Cálculo do saldo atual
                        const invest = price * qtde;
                        const formattedInvest = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(invest);

                        // Atualiza o campo "Saldo R$"
                        document.getElementById(`saldo_${coinName}`).textContent = formattedInvest;

                        // Atualiza o campo "Preço Atual" em formato de moeda local (R$)
                        document.getElementById(`price_${coinName}`).textContent = price.toLocaleString('pt-BR', {
                            style: 'currency',
                            currency: 'BRL',
                        });

                        // Verifica alertas de preço e calcula o ganho
                        checkPriceAlerts(coinName, price);
                        calculateGain(coinName, price);
                    })
                    .catch(error => {
                        console.error(`Erro ao buscar dados para ${coinName}:`, error);
                        // Tentar usar o widget da CoinMarketCap como fallback para exibir o preço
                        console.log('Usando widget da CoinMarketCap como fallback');
                    });
            });
        }
        

        /**
         * Atualiza os ganhos de todas as moedas
         * @param {Object} prices - Objeto com os preços atuais das moedas
         */
        function updateAllGains(prices) {
            UserCoins.forEach(crypto => calculateGain(crypto.name.toLowerCase(), prices));
        }
       
        /**
         * Calcula e atualiza o ganho para uma moeda específica
         * @param {string} currencyId - ID da moeda
         * @param {number} currentPrice - Preço atual da moeda
         */
        function calculateGain(currencyId, currentPrice = 0) {
            const invested = parseFloat(localStorage.getItem(`crypto_${currentUser}_${currencyId}_invested`)) || 0;
            const qtde = parseFloat(localStorage.getItem(`crypto_${currentUser}_${currencyId}_qtde`)) || 0;

            const gain = (currentPrice * qtde) - invested;
            const formattedGain = new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(gain);

            const gainElement = document.getElementById(`gain_${currencyId}`);
            gainElement.textContent = formattedGain;

            gainElement.classList.remove('positive', 'negative');
            gainElement.classList.add(gain >= 0 ? 'positive' : 'negative');
            localStorage.setItem(`crypto_${currentUser}_${currencyId}_gain`, formattedGain);
        }
            
        window.onload = () => {
            fetchCurrentPrices();
            setInterval(fetchCurrentPrices, refreshInterval * 1000);   //qtde de seguntos até pesquisar novos valores das moedas
        };
    </script>

    <div id="cryptoContainer">
        <div class="coinmarketcap-currency-widget" 
            data-currencyid="2" 
            data-base="LTC"
            data-secondary="BRL"
            data-theme="dark">
        </div>
    </div>

    <div class="marquee-container">
        <div id="coinmarketcap-widget-marquee" 
            coins="2,7083,5426,1" 
            currency="BRL" 
            theme="dark" 
            transparent="true" 
            show-symbol-logo="true"
            style="max-width: 100%; height: 40px;">
        </div>
    </div>
</body>
</html>
